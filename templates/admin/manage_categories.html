{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Manage Categories</h2>
    
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Search and Add Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Search Bar -->
        <div class="w-50 position-relative">
            <input type="text" id="categorySearch" class="form-control form-control-lg" 
                   placeholder="Search categories..." aria-label="Search categories">
            <div id="searchResults" class="position-absolute w-100 mt-1 d-none" 
                 style="z-index: 1000; max-height: 300px; overflow-y: auto; background: white; border-radius: 0.375rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
                <!-- Search results will appear here -->
            </div>
        </div>
        
        <!-- Add New Category Button -->
        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-plus me-2"></i>Add New Category
        </button>
    </div>

    <!-- Categories Display (Card Layout) -->
    <div id="categoriesContainer" class="row">
        {% for cat in categories %}
        <div class="col-md-6 col-lg-4 mb-4 category-card" data-name="{{ cat.name|lower }}" data-id="{{ cat.id }}">
            <div class="card h-100 shadow-sm animate__animated animate__fadeIn">
                <div class="card-body">
                    <h5 class="card-title">{{ cat.name }}</h5>
                    <p class="card-text">{{ cat.description or "No description provided" }}</p>
                </div>
                <div class="card-footer bg-transparent d-flex justify-content-between">
                    <button class="btn btn-outline-primary btn-sm edit-category" data-bs-toggle="modal" 
                            data-bs-target="#editCategoryModal" data-id="{{ cat.id }}" 
                            data-name="{{ cat.name }}" data-description="{{ cat.description }}">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <form action="{{ url_for('admin.delete_category', category_id=cat.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger btn-sm" 
                                onclick="return confirm('Are you sure you want to delete this category?')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                No categories found. Add your first category using the button above.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.add_category') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCategoryForm" action="" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .category-card {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    #searchResults {
        transition: all 0.3s ease;
    }
    
    .search-result-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
        background-color: #f8f9fa;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('categorySearch');
        const searchResults = document.getElementById('searchResults');
        const categoryCards = document.querySelectorAll('.category-card');
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                searchResults.classList.add('d-none');
                // Show all categories
                categoryCards.forEach(card => {
                    card.style.display = 'block';
                    setTimeout(() => {
                        card.classList.add('animate__fadeIn');
                    }, 50);
                });
                return;
            }
            
            // Filter categories for live search results
            const filteredCategories = Array.from(categoryCards).filter(card => {
                const categoryName = card.getAttribute('data-name');
                return categoryName.includes(searchTerm);
            });
            
            // Update search results dropdown
            if (filteredCategories.length > 0) {
                let resultsHTML = '';
                filteredCategories.forEach(card => {
                    const categoryId = card.getAttribute('data-id');
                    const categoryName = card.querySelector('.card-title').textContent;
                    const categoryDesc = card.querySelector('.card-text').textContent;
                    
                    resultsHTML += `
                        <div class="search-result-item" data-id="${categoryId}">
                            <div class="fw-bold">${categoryName}</div>
                            <div class="small text-muted">${categoryDesc}</div>
                        </div>
                    `;
                });
                
                searchResults.innerHTML = resultsHTML;
                searchResults.classList.remove('d-none');
                
                // Add click event to search results
                document.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-id');
                        const categoryElement = document.querySelector(`.category-card[data-id="${categoryId}"]`);
                        
                        // Highlight the selected category
                        categoryCards.forEach(card => {
                            card.classList.remove('animate__pulse');
                            if (card.getAttribute('data-id') === categoryId) {
                                card.classList.add('animate__pulse');
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                
                                // Remove highlight after 2 seconds
                                setTimeout(() => {
                                    card.classList.remove('animate__pulse');
                                }, 2000);
                            }
                        });
                        
                        searchResults.classList.add('d-none');
                        searchInput.value = '';
                    });
                });
            } else {
                searchResults.innerHTML = '<div class="search-result-item">No categories found</div>';
                searchResults.classList.remove('d-none');
            }
            
            // Show/hide categories based on search
            categoryCards.forEach(card => {
                const categoryName = card.getAttribute('data-name');
                if (categoryName.includes(searchTerm)) {
                    card.style.display = 'block';
                    setTimeout(() => {
                        card.classList.add('animate__fadeIn');
                    }, 50);
                } else {
                    card.classList.remove('animate__fadeIn');
                    card.style.display = 'none';
                }
            });
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('d-none');
            }
        });
        
        // Edit category modal handler
        const editCategoryModal = document.getElementById('editCategoryModal');
        if (editCategoryModal) {
            editCategoryModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const categoryId = button.getAttribute('data-id');
                const categoryName = button.getAttribute('data-name');
                const categoryDescription = button.getAttribute('data-description');
                
                const modal = this;
                modal.querySelector('#editName').value = categoryName;
                modal.querySelector('#editDescription').value = categoryDescription;
                
                // Update form action
                const form = modal.querySelector('#editCategoryForm');
                form.action = "{{ url_for('admin.edit_category', category_id=0) }}".replace('0', categoryId);
            });
        }
    });
</script>

<!-- Include Animate.css for animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<!-- Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
{% endblock %}